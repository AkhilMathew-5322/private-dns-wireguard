services:
  wireguard:
    image: lscr.io/linuxserver/wireguard
    container_name: wireguard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
    environment:
      PUID: 1000
      PGID: 1000
      TZ: Asia/Dubai
      SERVERURL: vpn.example.com
      SERVERPORT: 51820
      PEERS: phone
      PEERDNS: 10.8.0.1
      INTERNAL_SUBNET: 10.8.0.0/24
    volumes:
      - wireguard_config:/config
    ports:
      - "51820:51820/udp"
    restart: unless-stopped

  technitium-dns:
    image: technitium/dns-server:latest
    container_name: technitium-dns
    network_mode: "service:wireguard"
    depends_on:
      - wireguard
    environment:
      DNS_SERVER_DOMAIN: dns.private
      DNS_SERVER_RECURSION: AllowOnlyForPrivateNetworks
      DNS_SERVER_ENABLE_BLOCKING: true
      DNS_SERVER_FORWARDERS: 1.1.1.1,8.8.8.8
      DNS_SERVER_WEB_SERVICE_LOCAL_ADDRESSES: 0.0.0.0
      DNS_SERVER_WEB_SERVICE_HTTP_PORT: 5380
      DNS_SERVER_WEB_SERVICE_ENABLE_HTTPS: false
    volumes:
      - technitium_config:/etc/dns
    restart: unless-stopped

volumes:
  wireguard_config:
  technitium_config:
